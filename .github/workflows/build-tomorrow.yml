name: Build Tomorrow Schedule

on:
  schedule:
    # Run hourly and only proceed at 18:00 Europe/London
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Compute London date and guard hour
        id: date
        run: |
          node -e "const tz='Europe/London'; const now=new Date(); const london=new Date(now.toLocaleString('en-GB',{timeZone:tz})); const hour=london.getHours(); if (hour!==18) { console.log('Not 18:00â€“18:59 Europe/London'); require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 'date=\\n'); process.exit(0); } const tomorrow=new Date(london); tomorrow.setDate(tomorrow.getDate()+1); const iso=tomorrow.toISOString().slice(0,10); require('fs').appendFileSync(process.env.GITHUB_OUTPUT, `date=${iso}\\n`);"

      - name: Build tomorrow.json
        if: steps.date.outputs.date != ''
        run: node build.js --date=${{ steps.date.outputs.date }}

      - name: Fetch weather
        if: steps.date.outputs.date != ''
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: node scripts/fetch-weather.js

      - name: Commit and push
        if: steps.date.outputs.date != ''
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add public/today.json public/week.json public/weather.json
          git commit -m "Automated build for ${{ steps.date.outputs.date }}"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/pablosed/hmi-poc.git
          git push
